<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../bower_components/photo-gallery/photo-gallery.html">

<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="single-view-shared-styles.html">

<script async src="../bower_components/moment/min/moment.min.js"></script>
<script async src="../bower_components/vibrant/dist/Vibrant.min.js"></script>

<script src="states.js"></script>

<dom-module id="work-view">
  <template>
    <style include="shared-styles"></style>
    <style include="paper-date-picker-dialog-style"></style>
    <style include="single-view-shared-styles">
      :host{
        --progress-color: #333;
      }

      paper-chip-input-autocomplete{
        --paper-chip-autocomplete-focus-color: var(--progress-color); /*Underline color when focused*/
        --paper-input-container-color: rgba(255, 255, 255, 0.7); /*Label color when not focused*/

        --paper-chip-background-color: rgba(255, 255, 255, 0.05);
        --paper-chip-active-background-color: rgba(255, 255, 255, 0.1);

        --paper-chip-label-color: rgba(255, 255, 255, 0.9);
        --paper-chip-close-color: white;
        --paper-chip-close-icon-color: #444;
      }
      #categories_input{
        --paper-chip-autocomplete-focus-color: white; /*Underline color when focused*/
        --paper-chip-background-color: rgba(0, 0, 0, 0.05);
        --paper-chip-active-background-color: rgba(0, 0, 0, 0.1);
      }
      paper-input, paper-textarea{
        --paper-input-container-focus-color: var(--progress-color);
      }
      paper-textarea{
        --paper-input-container-input: {
          font-size: 15px;
        }
      }
      #date_input{
        width: 140px;
        --paper-input-suffix:{
          color: rgba(255, 255, 255, 0.5);
        }
      }
      #datepicker_dialog{
        --default-primary-color: var(--progress-color);
        --paper-dialog-button-color: var(--progress-color);
        --light-primary-color: rgba(0, 0, 0, 0.3);
      }

      #placeholder_card iron-image{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--card-image-bg-color);
      }
      #offline_work{
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
      }
      #offline_work iron-icon{
        color: rgba(255, 255, 255, 0.5);
        width: 48px;
        height: 48px;
      }
      #information{
        @apply --layout-horizontal;
        margin-bottom: 24px;
      }
      .info_group:nth-child(2){
        padding: 0px 30px;
      }
      .info_item{
        margin-bottom: 12px;
      }
      .info_item_title{
        color: var(--card-date-color);
        margin-bottom: 4px;
        font-size: 14px;
        font-weight: 500;
      }
      .info_chip{
        background-color: var(--card-image-bg-color);
        color: var(--card-description-color);
        font-size: 15px;
        border-radius: 30px;
        padding: 2px 12px;
        margin: 2px;
        cursor: default;
        white-space: nowrap;
      }
      #action_link{
        line-height: 0;
        margin-top: 20px;
      }
      #action_button{
        background-color: var(--progress-color, #333);
        transition: background-color 0.8s ease;
      }
      #action_button iron-icon{
        width: 20px;
        height: 20px;
        margin-left: 6px;
        margin-bottom: 2px;
      }

      photo-gallery .item{
        background-color: var(--card-image-bg-color);
      }
      .multimedia_group{
        margin-top: 36px;
      }
      .multimedia_title{
        margin-bottom: 16px;
      }
      .video_item{
        width: calc(50% - 4px);
        margin-bottom: 8px;
      }

      @media (max-width: 600px) {
        #information{
          @apply --layout-vertical;
        }
        .info_group:nth-child(2){
          padding: 10px 0;
        }
        .info_chip{
          font-size: 13px;
        }
      }
    </style>

    <app-route route="{{route}}" pattern="/:slug" data="{{routeData}}"></app-route>

    <firebase-query
      app-name="alejost848"
      path="/works"
      order-by-child="slug"
      equal-to="[[routeData.slug]]"
      data="{{data}}"
      online="{{online}}">
    </firebase-query>

    <paper-progress id="video_progress" value="{{videoCurrentTime}}" max="{{videoDuration}}"></paper-progress>

    <div id="title_header" class="layout horizontal center">
      <template is="dom-if" if="[[dataLoaded]]">
        <div>
          <paper-input id="title_input" label="Title" value="{{work.title}}"></paper-input>
          <paper-chip-input-autocomplete
            id="categories_input"
            label="Add a category..."
            no-label-float items="[[work.categories]]"
            additional-items source="[[states]]"
            closable>
          </paper-chip-input-autocomplete>
        </div>
      </template>
    </div>
    <div id="card">
      <template is="dom-if" if="[[!online]]">
        <div id="placeholder_card">
          <div id="offline_work" class="layout vertical center-center">
            <iron-icon icon="alejost-icons:cloud-off"></iron-icon>
          </div>
        </div>
      </template>

      <template is="dom-if" if="[[online]]" restamp="true">
        <template is="dom-if" if="[[!dataLoaded]]">
          <div id="placeholder_card"></div>
          <paper-progress id="loading_progress" indeterminate></paper-progress>
        </template>

        <template is="dom-if" if="[[dataLoaded]]" restamp="true">
          <template is="dom-if" if="[[work.videoId]]" restamp="true">
            <google-youtube
              id="video"
              fluid
              video-id="[[work.videoId]]"
              showinfo="0"
              currenttime="{{videoCurrentTime}}"
              duration="{{videoDuration}}"
              rel="0">
            </google-youtube>
          </template>

          <template is="dom-if" if="[[!work.videoId]]">
            <div id="placeholder_card">
              <iron-image src="[[work.coverImage]]" preload fade sizing="cover"></iron-image>
            </div>
          </template>

          <!-- HACK: Hidden image for getting the main color -->
          <img on-load="_getMainColor" src="https://cors-anywhere.herokuapp.com/[[work.thumbnail]]" crossorigin="Anonymous" hidden>
        </template>
      </template>

      <template is="dom-if" if="[[dataLoaded]]">
        <div id="card_content">

          <paper-fab toast-open="[[toastOpen]]"></paper-fab>

          <div id="information">
            <div class="info_group info_item flex-4 layout vertical start">

              <paper-input id="date_input" label="Published date" value="{{work.publishedDate}}" placeholder="YYYY-MM-DD">
                <paper-icon-button slot="suffix" icon="alejost-icons:event" on-tap="_openDatePicker"></paper-icon-button>
              </paper-input>

              <paper-textarea id="description" label="Description" value="{{work.shortDescription}}"></paper-textarea>
              <span class="flex"></span>
              <a id="action_link" href="[[work.button.url]]" target="_blank" class="link" rel="noopener">
                <paper-button raised id="action_button" class="raised_button">
                  [[work.button.text]]
                  <iron-icon icon="alejost-icons:open-in-new"></iron-icon>
                </paper-button>
              </a>
            </div>
            <div class="info_group flex-3">
              <div class="info_item">
                <div class="info_item_title">Client</div>
                <paper-chip-input-autocomplete
                  label="Add a client..."
                  no-label-float items="[[work.clients]]"
                  source="[[states]]"
                  additional-items
                  closable>
                </paper-chip-input-autocomplete>
              </div>
              <div class="info_item">
                <div class="info_item_title">Tools used</div>
                <paper-chip-input-autocomplete
                  label="Add a tool..."
                  no-label-float items="[[work.toolsUsed]]"
                  source="[[states]]"
                  additional-items
                  closable>
                </paper-chip-input-autocomplete>
              </div>
            </div>
            <div class="info_group flex-3">
              <div class="info_item">
                <div class="info_item_title">Credits</div>
                <paper-chip-input-autocomplete
                  label="Add a person..."
                  no-label-float items="[[work.credits]]"
                  source="[[states]]"
                  additional-items
                  closable>
                </paper-chip-input-autocomplete>
              </div>
            </div>
          </div>

          <div class="multimedia_group">
            <div class="multimedia_title info_item_title">Images</div>
            <photo-gallery height="150">
              <template is="dom-repeat" items="[[work.images]]" as="image">
                <div class="item" data-url$="[[image]]"></div>
              </template>
            </photo-gallery>
          </div>

          <div class="multimedia_group">
            <div class="multimedia_title info_item_title">Videos</div>
            <div class="layout horizontal wrap justified">
              <template is="dom-repeat" items="[[work.videos]]" as="video">
                <google-youtube
                  class="video_item"
                  fluid
                  video-id="[[video]]"
                  showinfo="0"
                  rel="0">
                </google-youtube>
              </template>
            </div>
          </div>

        </div>

      </template>
    </div>

    <paper-dialog id="datepicker_dialog" class="paper-date-picker-dialog" scroll-action="lock" on-iron-overlay-closed="_closeDatePickerDialog">
      <paper-date-picker id="picker" date="{{_selectedDate}}"></paper-date-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class WorkView extends Polymer.Element {
      static get is() { return 'work-view'; }

      static get properties() {
        return {
          active: {
            type: Boolean,
            observer: '_activeChanged',
          },
          data: {
            type: Array,
            observer: '_dataChanged'
          },
          toastOpen: {
            type: Boolean,
            observer: '_toastOpened'
          }
        };
      }

      _closeDatePickerDialog(e){
        let confirmed = e.detail.confirmed;
        if (confirmed) {
          this.set('work.publishedDate', moment(this._selectedDate).format("YYYY-MM-DD"));
        }
      }

      ready(){
        super.ready();
        this.states = states;
      }

      _dataChanged(data){
        this.dataLoaded = false;
        if (data.length > 0) {
          this.work = data[0];

          this._updateMetadata();

          // HACK: Wait a ms to set the dataLoaded to true and trigger the video restamp
          setTimeout(() => {
            this.dataLoaded = true;
          },1);
        }
      }

      stopPlayback() {
        if (this.online && this.work.videoId) {
          this.shadowRoot.querySelector('#video').pause();
        }
      }

      _activeChanged(active) {
        if (!active) {
          this.stopPlayback();

          //Change browser theme color
          let metaThemeColor = document.querySelector('meta[name=theme-color]');

          //Get a CSS property depending on whether the shady CSS polyfill is loaded:
          let bgColor;
          if (ShadyCSS) {
            bgColor = ShadyCSS.getComputedStyleValue(this, '--app-background-color');
          } else {
            bgColor = getComputedStyle(this).getPropertyValue('--app-background-color');
          }
          metaThemeColor.setAttribute("content", bgColor);

          //Change background color for the work-view
          this.updateStyles({
            '--progress-color': '#333'
          });
        } else if (active && this.dataLoaded) {
          this._updateMetadata();

          //Change background color for the work-view
          this.updateStyles({
            '--progress-color': '#' + this.mainColor
          });
        }
      }

      _updateMetadata(){
        window.dispatchEvent(new CustomEvent('sherby-metadata', {
          detail: {
            "og:site_name": "Alejandro Sanclemente",
            "title": this.work.title + " | Alejandro Sanclemente",
            "og:title": this.work.title + " | Alejandro Sanclemente",
            "description": this.work.shortDescription,
            "og:description": this.work.shortDescription,
            "og:type": "article",
            "og:image": this.work.thumbnail,
            "og:url": window.location.href
          }
        }));
      }

      _computeTimeAgo(publishedDate) {
        return "Published " + moment(publishedDate).fromNow();
      }

      _computeCategories(categories){
        return categories.join(" | ");
      }

      _getMainColor(e){
        var vibrant = new Vibrant(e.target, 8, 5);
        var swatches = vibrant.swatches();
        this.mainColor = swatches["Vibrant"].getHex().substring(1);

        //Change browser theme color
        let metaThemeColor = document.querySelector('meta[name=theme-color]');
        metaThemeColor.setAttribute("content", '#' + this.mainColor);

        //Change background color
        this.updateStyles({
          '--progress-color': '#' + this.mainColor
        });
      }

      _toastOpened(isOpen){
        this.toastOpen = isOpen;
      }

      _openDatePicker(){
        this.$.datepicker_dialog.open();
      }
    }

    window.customElements.define(WorkView.is, WorkView);
  </script>
</dom-module>
